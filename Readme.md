### This repository was created by [Pavel Filippenko](https://github.com/pavel-collab), [Mikhail Ovsiannikov](https://github.com/OAMichael) and [Andrey Barannikov](https://github.com/barannikovav).

### Понадобится установить следующее:
```console
pip install psutil
```
```console
pip install python-libxdo
```
```console
pip install python-telegram-bot
```
```console
pip install seaborn
```
```console
sudo apt-get install python3-gi gir1.2-wnck-3.0
```

#### Как запустить
##### На главном компьютере запускается программа `./MainServer.py`. На компьютерах работников запускаются программы `./Worker.py`, вводится никнейм, и таким образом они подключаются к серверу. Раз в 5 секунд `./Worker.py` получает нужную информацию и отправляет ее на сервер. Сервер же должен обработать эту информацию.


#### Что скрипт должен делать:
1. Получить информацию о компьютере данного работника
2. Передать ее на главный сервер
3. Сервер обрабатывает данную информацию:
	- Записывает все в базу данных
	- По возможности строит графики нужных величин
	- Выводит информацию по необходмому запросу
4. ~~Отсылать всю инфу боссу в телегу~~

#### Что скрипт делает на данный момент:
1. На сервере запускает [**телеграм-бота**](https://t.me/Conntrol_test_bot)
2. Каждый клиент получает следующую информацию о своем компьютере и системе:
	- Для каждого процесса получает:
		- Name
		- Create time
		- Status
		- RSS memory
		- VMS memory
		- Shared memory
		- Data memory
	- Количество процессов
	- Использование дисковой памяти
	- Частоту CPU (минимальную, максимальную и текущую)
	- Время запуска системы
	- Общее использование памяти
	- Температуру каждого ядра (текущую, максимальную и критическую)
	- Названия всех открытых окон
	- ID текущего окна
	- Имя текущего окна
	- Наиболее часто используемое окно и процентаж использования
	- Второе наиболее часто используемое окно и процентаж использования (если есть)
	- Третье наиболее часто используемое окно и процентаж использования (если есть)
	- Положение курсора в пикселях экрана (отсчет от левого верхнего края экрана)
	- ID окна над которым расположен курсор
	- Имя окна над которым расположен курсор
3. Вся эта информация передается серверу через TCP протокол. Он записывает все базу данных
4. В телеграм-боте по запросу '/info [Worker name]' выдается информация об активном окне работника по имени [Worker name] и присылается картинка с гистограммой не более трех наиболее используемых окон и процентаж использования.

***Замечание:*** при запуске программы `./MainServer.py` запускается дочерний процесс с телеграм-ботом `./TGBot.py` (пока что бот жив при условии, что компьютер того, кто запустил `./MainServer.py`, включен). Тот в свою очередь бесконечно спит, пока ~~босс~~ пользователь телеграма не запросит информацию. Как только это произошло, `./TGBot.py` запускает подпроцесс `./Plot.py` и ждет, пока построится и сохранится график, после чего уже отправляет картинку.


#### Пример гистограммы:

![Пример](./Graphs/WindowsAndrey.png)

# База данных

Работы с базой данны построена на базе фрэймворка sqlalchemy, поэтому для работы с ним неободимо установить этот фрэймворк.
```consol
pip install sqlalchemy
```
Кроме того для теста вам понадобится пакет Faker (предназначен для заполнения базы фэйковой информацией, если вам необходимо протестировать базу)
```colsol
pip install faker
```

## Структура

В папке models лежат файлы с описанием моделей и соответсвующих таблиц, которые используются в работе. Конкретно: user.py -- описание объекта пользователь, computer.py -- объект компьютер (ка одним компьютером работает один пользователь), applications.py -- таблица приложений, которые запускались всеми пользователями (хотя бы раз за рабочий день). Файл Database.py содержит описание базы данных (имя, используемый движок (СУБД) а так же исходную модель объекта, от которого наследуются все остальные таблицы).

В основной дериктории сожержится файл CreateDB.py, который содержит функцию создания таблицы __create_database(load_fake_data: bool = True)__. По умолчанию параметр выставлен на True, это значит, что при создании базы она заполнится фэйковыми данными (за это отвечает функция load_fake_data). Для того чтобы создать пустую таблицу неободимо вызвать эту функцию с параметром False: create_database(False).

Рекомендуется сначала создать базу данных с фэйковыми данными и потренировать использваоние функций из модуля DB_access.py на ней. Для того, чтобы открыть базу данных в sqlitebrowse для просмотра выполните в консоли команду
```consol
sqlitebrowser worker_base.sqlite
```

В файле main_db.py вызывается функцию создания базы данных, если файла с именем базы еще нет в рабочем каталоге (Предполагается, что создание базы и обращения к ней в последствии будут происходить в други частях проекта main_bd просто тестовый вариант).

## DB_access.py

В этом модуле содержатся функции редактирования базы и функции запросов.

Функции запросов к базе:
- GetComputerInfo() возвращает объект Computer c актуальной информацией по текущему пользователю (3 наиболее используемые окна, процент их использования, и др)
- GetUsers() возращает список пользователей в системе
- GetAuthorisationTime() возвращает словарь: пользователь -> время авторизации в системе
- GetExitTime() возвращает словарь: пользователь -> время выхода пользователя из системы
- GetAppsList() по заданному имени пользователя возвращает список всех приложений, которые открывались на его компьютере
- GetMostUsableWindows() для данного момента времени возвращает два списка: наиболее используемые заданным пользователем окна и процентаж их использования