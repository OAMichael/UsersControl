### This repository was created by [Pavel Filippenko](https://github.com/pavel-collab), [Mikhail Ovsiannikov](https://github.com/OAMichael) and [Andrey Barannikov](https://github.com/barannikovav).

### Понадобится установить следующее:
```console
pip install psutil
pip install python-libxdo
pip install python-telegram-bot
pip install seaborn
pip install sqlalchemy
pip install faker
pip install PyQt5
sudo apt-get install python3-gi gir1.2-wnck-3.0
```

#### Как запустить
##### На главном компьютере запускается программа `MainServer.py`. На компьютерах работников запускаются программы `Worker.py`. В качестве аргументов командной строки должны присутствовать пути к файлам конфигураций соответственно для сервера и работника. Раз в 5 секунд `Worker.py` получает нужную информацию и отправляет ее на сервер. Сервер же обрабатывает эту информацию и записывает в базу данных. Если в конфиге для сервера прописать `bot = True`, то запускается телеграм-бот, через которого босс может запросить информацию о работниках в целом и каком-то конкретном. Вдобавок, на локальном сервере можно запустить программу `QtBase.py`, через которую можно наблюдать всю собранную сервером информацию в виде таблиц.


#### Что скрипт должен делать:
1. Получить информацию о компьютере данного работника
2. Передать ее на главный сервер
3. Сервер обрабатывает данную информацию:
	- Записывает все в базу данных
	- По возможности строит графики нужных величин
	- Выводит информацию по необходмому запросу
4. При запуске `QtBase.py` выводится вся информация о работниках
5. ~~Отсылать всю инфу боссу в телегу~~

#### Что скрипт делает на данный момент:
1. Запускает главный сервер. На сервере запускает [**телеграм-бота**](https://t.me/Conntrol_test_bot), если установлен флаг `bot = True` в конфиге для сервера
2. Каждый клиент получает следующую информацию о своем компьютере и системе:
	- Для процессов, связанных с открытыми окнами, получает:
		- Name
		- Create time
		- Status
		- RSS memory
		- VMS memory
		- Shared memory
		- Data memory
	- Количество процессов
	- Использование дисковой памяти
	- Частоту CPU (минимальную, максимальную и текущую)
	- Время запуска системы
	- Общее использование памяти
	- Названия всех открытых окон
	- Имя текущего окна
	- Наиболее часто используемое окно и процентаж использования
	- Второе наиболее часто используемое окно и процентаж использования (если есть)
	- Третье наиболее часто используемое окно и процентаж использования (если есть)
3. Вся эта информация передается серверу через TCP протокол. Он записывает все базу данных SQL
4. В телеграм-боте по запросу с помощью команд или интерактивной клавиатуры выдается информация, оговоренная выше, о работнике с конкретным именем и присылается картинка с гистограммой не более трех наиболее используемых окон и процентаж использования.

***Замечание 1:*** при запуске программы `MainServer.py` с конфигом `bot = True` запускается дочерний процесс с телеграм-ботом `TGBot.py` (пока что бот жив при условии, что компьютер того, кто запустил `MainServer.py`, включен). Тот в свою очередь бесконечно спит, пока босс в телеграме не запросит информацию. Как только это произошло, `TGBot.py` запускает подпроцесс `Plot.py` и ждет, пока построится и сохранится график, после чего уже отправляет картинку и дополнительную информацию.


***Замечание 2:*** в репозитории есть файлы для классов клиента и сервера: `client.py` и `server.py` соответственно. На данный момент в основную программу полноценно сынтегрирован только класс клиента. Работа по цельному внедрению сервера продолжается.


# База данных

Работа с базой данных построена на базе фрэймворка sqlalchemy, поэтому для работы с ним неободимо установить этот фрэймворк.
```consol
pip install sqlalchemy
```
Кроме того, для теста вам понадобится пакет Faker (предназначен для заполнения базы фэйковой информацией, если вам необходимо протестировать базу)
```colsol
pip install faker
```

## Структура

В директории models лежат файлы с описанием моделей и соответсвующих таблиц, которые используются в работе. Конкретно: `user.py` - описание объекта пользователь, `computer.py` - объект компьютер (за одним компьютером работает один пользователь), `applications.py` - таблица приложений, которые запускались всеми пользователями (хотя бы раз за рабочий день). Файл `Database.py` содержит описание базы данных (имя, используемый движок (СУБД) а так же исходную модель объекта, от которого наследуются все остальные таблицы).

В основной директории сожержится файл `CreateDB.py`, который содержит функцию создания таблицы `__create_database(load_fake_data: bool = True)__`. По умолчанию параметр выставлен на `True`, это значит, что при создании базы она заполнится фэйковыми данными (за это отвечает функция `load_fake_data`). Для того чтобы создать пустую таблицу необходимо вызвать эту функцию с параметром `False`: `create_database(False)`.

Рекомендуется сначала создать базу данных с фэйковыми данными и потренировать использваоние функций из модуля `DB_access.py` на ней. Для того, чтобы открыть базу данных в sqlitebrowse для просмотра выполните в консоли команду
```consol
sqlitebrowser worker_base.sqlite
```

В файле `main_db.py` вызывается функция создания базы данных, если файла с именем базы еще нет в рабочем каталоге (предполагается, что создание базы и обращения к ней в последствии будут происходить в других частях проекта, `main_bd.py` - это просто тестовый вариант).

## DB_access.py

В этом модуле содержатся функции редактирования базы и функции запросов.

Функции запросов к базе:
- `GetComputerInfo()` возвращает объект **Computer** c актуальной информацией по текущему пользователю (3 наиболее используемые окна, процент их использования, и др)
- `GetUsers()` возращает список пользователей в системе
- `GetAuthorisationTime()` возвращает словарь: пользователь -> время авторизации в системе
- `GetExitTime()` возвращает словарь: пользователь -> время выхода пользователя из системы
- `GetAppsList()` по заданному имени пользователя возвращает список всех приложений, которые открывались на его компьютере
- `GetMostUsableWindows()` для данного момента времени возвращает два списка: наиболее используемые заданным пользователем окна и процентаж их использования
